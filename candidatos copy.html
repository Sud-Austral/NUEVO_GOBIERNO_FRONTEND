<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candidatos - Sistema de Gestión de Candidaturas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #1e3a8a;
            --secondary-color: #3b82f6;
            --accent-color: #60a5fa;
            --light-bg: #f8fafc;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: #333;
        }
        
        .navbar {
            background-color: var(--primary-color);
            box-shadow: var(--card-shadow);
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.4rem;
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.85) !important;
            transition: all 0.3s;
            border-radius: 0.25rem;
            margin: 0 0.2rem;
        }
        
        .nav-link:hover {
            color: white !important;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .nav-link.active {
            color: white !important;
            background-color: var(--secondary-color);
        }
        
        .section-card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent-color);
        }
        
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .btn-logout {
            background-color: #dc2626;
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            transition: background-color 0.3s;
        }
        
        .btn-logout:hover {
            background-color: #b91c1c;
        }
        
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-active { background-color: #dcfce7; color: #166534; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-inactive { background-color: #fee2e2; color: #991b1b; }
        .status-evaluating { background-color: #dbeafe; color: #1e40af; }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        footer {
            background-color: var(--primary-color);
            color: white;
            padding: 1.5rem 0;
            margin-top: 2rem;
        }

        .candidato-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .evaluacion-item {
            border-left: 3px solid var(--accent-color);
            padding-left: 15px;
            margin-bottom: 15px;
        }

        .evaluacion-item .evaluador {
            font-weight: bold;
            color: var(--primary-color);
        }

        .evaluacion-item .fecha {
            font-size: 0.85rem;
            color: #64748b;
        }

        .evaluacion-item .puntaje {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--secondary-color);
        }

        .filter-section {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: var(--card-shadow);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-floating label {
            color: #64748b;
        }

        .rating-stars {
            color: #fbbf24;
            font-size: 1.5rem;
        }

        .evaluacion-form {
            background-color: #f8fafc;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- Navegación -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-briefcase-fill me-2"></i>
                Sistema de Gestión de Candidaturas
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="bi bi-speedometer2 me-1"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="cargos.html">
                            <i class="bi bi-briefcase me-1"></i> Cargos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="candidatos.html">
                            <i class="bi bi-people me-1"></i> Candidatos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="postulaciones.html">
                            <i class="bi bi-file-earmark-text me-1"></i> Postulaciones
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="comparador.html">
                            <i class="bi bi-bar-chart-line me-1"></i> Comparador
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="reportes.html">
                            <i class="bi bi-file-earmark-bar-graph me-1"></i> Reportes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="perfil.html">
                            <i class="bi bi-person-circle me-1"></i> Perfil
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="resultados.html">
                            <i class="bi bi-clipboard-data me-1"></i> Resultados
                        </a>
                    </li>
                </ul>
                <button class="btn btn-logout" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-1"></i> Cerrar sesión
                </button>
            </div>
        </div>
    </nav>

    <!-- Contenido principal -->
    <main class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">Gestión de Candidatos</h1>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-floating">
                        <input type="text" class="form-control" id="filtro-nombre" placeholder="Buscar por nombre">
                        <label for="filtro-nombre">Buscar por nombre</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating">
                        <select class="form-select" id="filtro-partido">
                            <option value="">Todos los partidos</option>
                        </select>
                        <label for="filtro-partido">Partido Político</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating">
                        <select class="form-select" id="filtro-estado">
                            <option value="">Todos los estados</option>
                            <option value="activo">Activo</option>
                            <option value="inactivo">Inactivo</option>
                            <option value="en revisión">En revisión</option>
                        </select>
                        <label for="filtro-estado">Estado</label>
                    </div>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="aplicarFiltros()">
                        <i class="bi bi-funnel me-1"></i> Aplicar
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabla de Candidatos -->
        <div class="section-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="section-title mb-0">Lista de Candidatos</h3>
                <div>
                    <button class="btn btn-outline-secondary me-2" onclick="exportarDatos()">
                        <i class="bi bi-download me-1"></i> Exportar
                    </button>
                    <button class="btn btn-primary" onclick="window.location.href='candidato-form.html'">
                        <i class="bi bi-plus-circle me-1"></i> Nuevo Candidato
                    </button>
                </div>
            </div>
            <div class="table-container">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Nombre</th>
                            <th>RUT</th>
                            <th>Partido</th>
                            <th>Contacto</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-candidatos">
                        <tr><td colspan="7" class="text-center"><div class="loading-spinner mx-auto"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal Detalles Candidato -->
    <div class="modal fade" id="detallesCandidatoModal" tabindex="-1" aria-labelledby="detallesCandidatoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detallesCandidatoModalLabel">Detalles del Candidato</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <div class="candidato-avatar mx-auto mb-3" id="avatar-inicial">
                                <!-- Inicial del nombre -->
                            </div>
                            <h4 id="nombre-completo"></h4>
                            <p class="text-muted" id="rut-candidato"></p>
                            <span class="status-badge" id="estado-badge"></span>
                        </div>
                        <div class="col-md-8">
                            <h6>Información Personal</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Fecha de Nacimiento:</strong></td>
                                    <td id="fecha-nacimiento"></td>
                                </tr>
                                <tr>
                                    <td><strong>Nacionalidad:</strong></td>
                                    <td id="nacionalidad"></td>
                                </tr>
                                <tr>
                                    <td><strong>Estado Civil:</strong></td>
                                    <td id="estado-civil"></td>
                                </tr>
                                <tr>
                                    <td><strong>Domicilio:</strong></td>
                                    <td id="domicilio"></td>
                                </tr>
                            </table>
                            
                            <h6>Contacto</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Email:</strong></td>
                                    <td id="email"></td>
                                </tr>
                                <tr>
                                    <td><strong>Teléfono:</strong></td>
                                    <td id="telefono"></td>
                                </tr>
                            </table>
                            
                            <h6>Información Política</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Partido Político:</strong></td>
                                    <td id="partido"></td>
                                </tr>
                                <tr>
                                    <td><strong>Región:</strong></td>
                                    <td id="region"></td>
                                </tr>
                                <tr>
                                    <td><strong>Provincia:</strong></td>
                                    <td id="provincia"></td>
                                </tr>
                            </table>
                            
                            <h6>Redes Sociales</h6>
                            <div class="d-flex flex-wrap gap-2" id="redes-sociales">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="verEvaluaciones()">Ver Evaluaciones</button>
                    <button type="button" class="btn btn-success" onclick="abrirModalEvaluacion()">Evaluar Candidato</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Evaluaciones del Candidato -->
    <div class="modal fade" id="evaluacionesModal" tabindex="-1" aria-labelledby="evaluacionesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="evaluacionesModalLabel">Evaluaciones del Candidato</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="evaluaciones-container">
                        <div class="text-center">
                            <div class="loading-spinner mx-auto"></div>
                            <p class="mt-2">Cargando evaluaciones...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success" onclick="abrirModalEvaluacion()">Nueva Evaluación</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Evaluación -->
    <div class="modal fade" id="nuevaEvaluacionModal" tabindex="-1" aria-labelledby="nuevaEvaluacionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nuevaEvaluacionModalLabel">Nueva Evaluación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="evaluacion-form">
                        <input type="hidden" id="evaluacion-id-candidato">
                        <input type="hidden" id="evaluacion-id-postulacion">
                        
                        <div class="mb-3">
                            <h5 id="evaluacion-nombre-candidato"></h5>
                            <p class="text-muted" id="evaluacion-cargo-candidato"></p>
                        </div>
                        
                        <div class="mb-3">
                            <label for="tipo-evaluacion" class="form-label">Tipo de Evaluación</label>
                            <select class="form-select" id="tipo-evaluacion" required>
                                <option value="">Seleccionar tipo de evaluación</option>
                                <option value="experiencia">Experiencia</option>
                                <option value="formacion">Formación Académica</option>
                                <option value="competencias">Competencias</option>
                                <option value="entrevista">Entrevista</option>
                                <option value="general">General</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="puntaje-evaluacion" class="form-label">Puntaje (1-100)</label>
                            <div class="d-flex align-items-center">
                                <input type="range" class="form-range me-3" min="1" max="100" id="puntaje-evaluacion">
                                <span class="puntaje-display fw-bold" id="puntaje-display">50</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="texto-evaluacion" class="form-label">Comentarios de la Evaluación</label>
                            <textarea class="form-control" id="texto-evaluacion" rows="5" placeholder="Ingrese sus comentarios sobre la evaluación..."></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="criterios-evaluacion" class="form-label">Criterios Evaluados</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="criterio1" value="liderazgo">
                                        <label class="form-check-label" for="criterio1">Liderazgo</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="criterio2" value="comunicacion">
                                        <label class="form-check-label" for="criterio2">Comunicación</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="criterio3" value="conocimiento">
                                        <label class="form-check-label" for="criterio3">Conocimiento del área</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="criterio4" value="trabajo-equipo">
                                        <label class="form-check-label" for="criterio4">Trabajo en equipo</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="criterio5" value="resolucion-problemas">
                                        <label class="form-check-label" for="criterio5">Resolución de problemas</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="criterio6" value="vision-estrategica">
                                        <label class="form-check-label" for="criterio6">Visión estratégica</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarEvaluacion()">Guardar Evaluación</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Sistema de Gestión de Candidaturas</h5>
                    <p>Plataforma integral para la gestión del proceso de selección de cargos gubernamentales</p>
                </div>
                <div class="col-md-3">
                    <h5>Enlaces rápidos</h5>
                    <ul class="list-unstyled">
                        <li><a href="dashboard.html" class="text-white">Dashboard</a></li>
                        <li><a href="candidatos.html" class="text-white">Candidatos</a></li>
                        <li><a href="cargos.html" class="text-white">Cargos</a></li>
                        <li><a href="reportes.html" class="text-white">Reportes</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Contacto</h5>
                    <p>
                        <i class="bi bi-envelope me-2"></i>info@candidaturas.gob.cl<br>
                        <i class="bi bi-telephone me-2"></i>+56 2 2345 6789
                    </p>
                </div>
            </div>
            <hr class="bg-white">
            <div class="text-center">
                <p>&copy; 2023 Gobierno de Chile - Todos los derechos reservados</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuración de la base URL
        const BASE_URL = 'https://186.67.61.251:8001';

        // Variables globales
        let candidatos = [];
        let partidos = [];
        let evaluaciones = [];
        let candidatoSeleccionado = null;
        let postulacionesCandidato = [];

        // Función de logout
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userRole');
            window.location.href = `/ALGARROBO_BASE/index.html`;
        }

        // --- FUNCIONES DE RENDERIZADO ---

        function renderCandidatosTable(candidatosFiltrados) {
            const tbody = document.getElementById('tabla-candidatos');
            if (!candidatosFiltrados || candidatosFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No hay candidatos para mostrar.</td></tr>';
                return;
            }
            
            tbody.innerHTML = candidatosFiltrados.map(candidato => {
                const nombreCompleto = `${candidato.nombres} ${candidato.apellido_paterno} ${candidato.apellido_materno || ''}`.trim();
                const inicial = nombreCompleto.charAt(0).toUpperCase();
                const estadoClass = candidato.estado_general === 'activo' ? 'status-active' : 
                                   candidato.estado_general === 'inactivo' ? 'status-inactive' : 'status-pending';
                
                return `
                    <tr>
                        <td>
                            <div class="candidato-avatar">${inicial}</div>
                        </td>
                        <td>${nombreCompleto}</td>
                        <td>${candidato.rut}</td>
                        <td>${candidato.nombre_partido || 'Sin partido'}</td>
                        <td>${candidato.contacto_email || 'N/A'}</td>
                        <td><span class="status-badge ${estadoClass}">${candidato.estado_general || 'N/A'}</span></td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" onclick="verDetalles(${candidato.id_candidato})" title="Ver detalles">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="abrirModalEvaluacionDirecto(${candidato.id_candidato})" title="Evaluar">
                                    <i class="bi bi-star"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="verEvaluacionesDirecto(${candidato.id_candidato})" title="Ver evaluaciones">
                                    <i class="bi bi-clipboard-check"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderDetallesCandidato(candidato) {
            const nombreCompleto = `${candidato.nombres} ${candidato.apellido_paterno} ${candidato.apellido_materno || ''}`.trim();
            const inicial = nombreCompleto.charAt(0).toUpperCase();
            const estadoClass = candidato.estado_general === 'activo' ? 'status-active' : 
                               candidato.estado_general === 'inactivo' ? 'status-inactive' : 'status-pending';
            
            // Avatar
            document.getElementById('avatar-inicial').textContent = inicial;
            
            // Información básica
            document.getElementById('nombre-completo').textContent = nombreCompleto;
            document.getElementById('rut-candidato').textContent = candidato.rut;
            document.getElementById('estado-badge').textContent = candidato.estado_general || 'N/A';
            document.getElementById('estado-badge').className = `status-badge ${estadoClass}`;
            
            // Información personal
            document.getElementById('fecha-nacimiento').textContent = candidato.fecha_nacimiento || 'N/A';
            document.getElementById('nacionalidad').textContent = candidato.nacionalidad || 'N/A';
            document.getElementById('estado-civil').textContent = candidato.estado_civil || 'N/A';
            document.getElementById('domicilio').textContent = candidato.domicilio || 'N/A';
            
            // Contacto
            document.getElementById('email').textContent = candidato.contacto_email || 'N/A';
            document.getElementById('telefono').textContent = candidato.contacto_telefono || 'N/A';
            
            // Información política
            document.getElementById('partido').textContent = candidato.nombre_partido || 'Sin partido';
            document.getElementById('region').textContent = candidato.nombre_region || 'N/A';
            document.getElementById('provincia').textContent = candidato.nombre_provincia || 'N/A';
            
            // Redes sociales
            const redesSociales = document.getElementById('redes-sociales');
            const redes = [];
            
            if (candidato.facebook) redes.push(`<a href="${candidato.facebook}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-facebook"></i></a>`);
            if (candidato.x_twitter) redes.push(`<a href="${candidato.x_twitter}" target="_blank" class="btn btn-sm btn-outline-info"><i class="bi bi-twitter-x"></i></a>`);
            if (candidato.linkedin) redes.push(`<a href="${candidato.linkedin}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-linkedin"></i></a>`);
            if (candidato.instagram) redes.push(`<a href="${candidato.instagram}" target="_blank" class="btn btn-sm btn-outline-danger"><i class="bi bi-instagram"></i></a>`);
            if (candidato.tiktok) redes.push(`<a href="${candidato.tiktok}" target="_blank" class="btn btn-sm btn-outline-dark"><i class="bi bi-tiktok"></i></a>`);
            if (candidato.youtube) redes.push(`<a href="${candidato.youtube}" target="_blank" class="btn btn-sm btn-outline-danger"><i class="bi bi-youtube"></i></a>`);
            if (candidato.website) redes.push(`<a href="${candidato.website}" target="_blank" class="btn btn-sm btn-outline-secondary"><i class="bi bi-globe"></i></a>`);
            
            redesSociales.innerHTML = redes.length > 0 ? redes.join(' ') : '<p class="text-muted">No hay redes sociales registradas</p>';
        }

        function renderEvaluaciones(evaluaciones) {
            const container = document.getElementById('evaluaciones-container');
            
            if (!evaluaciones || evaluaciones.length === 0) {
                container.innerHTML = '<p class="text-center">No hay evaluaciones registradas para este candidato.</p>';
                return;
            }
            
            container.innerHTML = evaluaciones.map(evaluacion => {
                const fecha = new Date(evaluacion.fecha_evaluacion).toLocaleDateString('es-CL');
                const hora = new Date(evaluacion.fecha_evaluacion).toLocaleTimeString('es-CL');
                
                return `
                    <div class="evaluacion-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="evaluador">${evaluacion.nombre_evaluador}</div>
                                <div class="fecha">${fecha} ${hora}</div>
                                <div class="tipo-evaluacion mt-1"><span class="badge bg-secondary">${evaluacion.tipo_evaluacion}</span></div>
                                <div class="comentarios mt-2">${evaluacion.texto_evaluacion || 'Sin comentarios'}</div>
                            </div>
                            <div class="text-end">
                                <div class="puntaje">${evaluacion.puntaje_numerico || 'N/A'}</div>
                                <div class="text-muted">Puntaje</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- FUNCIONES DE INTERACCIÓN ---

        function verDetalles(idCandidato) {
            const candidato = candidatos.find(c => c.id_candidato === idCandidato);
            if (!candidato) return;
            
            candidatoSeleccionado = candidato;
            renderDetallesCandidato(candidato);
            
            const modal = new bootstrap.Modal(document.getElementById('detallesCandidatoModal'));
            modal.show();
        }

        function verEvaluaciones() {
            if (!candidatoSeleccionado) return;
            
            // Cerrar modal de detalles
            const detallesModal = bootstrap.Modal.getInstance(document.getElementById('detallesCandidatoModal'));
            if (detallesModal) detallesModal.hide();
            
            // Cargar evaluaciones del candidato
            cargarEvaluacionesCandidato(candidatoSeleccionado.id_candidato)
                .then(() => {
                    const modal = new bootstrap.Modal(document.getElementById('evaluacionesModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error al cargar evaluaciones:', error);
                    alert('Error al cargar las evaluaciones del candidato');
                });
        }

        function verEvaluacionesDirecto(idCandidato) {
            const candidato = candidatos.find(c => c.id_candidato === idCandidato);
            if (!candidato) return;
            
            candidatoSeleccionado = candidato;
            
            // Cargar evaluaciones del candidato
            cargarEvaluacionesCandidato(idCandidato)
                .then(() => {
                    const modal = new bootstrap.Modal(document.getElementById('evaluacionesModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error al cargar evaluaciones:', error);
                    alert('Error al cargar las evaluaciones del candidato');
                });
        }

        function abrirModalEvaluacion() {
            if (!candidatoSeleccionado) return;
            
            // Cerrar modal de detalles o evaluaciones si están abiertos
            const detallesModal = bootstrap.Modal.getInstance(document.getElementById('detallesCandidatoModal'));
            const evaluacionesModal = bootstrap.Modal.getInstance(document.getElementById('evaluacionesModal'));
            
            if (detallesModal) detallesModal.hide();
            if (evaluacionesModal) evaluacionesModal.hide();
            
            // Preparar formulario de evaluación
            prepararFormularioEvaluacion(candidatoSeleccionado);
            
            // Abrir modal de evaluación
            const modal = new bootstrap.Modal(document.getElementById('nuevaEvaluacionModal'));
            modal.show();
        }

        function abrirModalEvaluacionDirecto(idCandidato) {
            const candidato = candidatos.find(c => c.id_candidato === idCandidato);
            if (!candidato) return;
            
            candidatoSeleccionado = candidato;
            
            // Preparar formulario de evaluación
            prepararFormularioEvaluacion(candidato);
            
            // Abrir modal de evaluación
            const modal = new bootstrap.Modal(document.getElementById('nuevaEvaluacionModal'));
            modal.show();
        }

        function prepararFormularioEvaluacion(candidato) {
            const nombreCompleto = `${candidato.nombres} ${candidato.apellido_paterno} ${candidato.apellido_materno || ''}`.trim();
            
            // Datos del candidato
            document.getElementById('evaluacion-id-candidato').value = candidato.id_candidato;
            document.getElementById('evaluacion-nombre-candidato').textContent = nombreCompleto;
            
            // Buscar postulación del candidato (usamos la primera que encontramos)
            const postulacion = postulacionesCandidato.length > 0 ? postulacionesCandidato[0] : null;
            document.getElementById('evaluacion-id-postulacion').value = postulacion ? postulacion.id_postulacion : '';
            document.getElementById('evaluacion-cargo-candidato').textContent = postulacion ? postulacion.nombre_cargo : 'Sin postulación registrada';
            
            // Resetear formulario
            document.getElementById('tipo-evaluacion').value = '';
            document.getElementById('puntaje-evaluacion').value = 50;
            document.getElementById('puntaje-display').textContent = '50';
            document.getElementById('texto-evaluacion').value = '';
            
            // Desmarcar todos los criterios
            document.querySelectorAll('#nuevaEvaluacionModal input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        function guardarEvaluacion() {
            const idCandidato = document.getElementById('evaluacion-id-candidato').value;
            const idPostulacion = document.getElementById('evaluacion-id-postulacion').value;
            const tipoEvaluacion = document.getElementById('tipo-evaluacion').value;
            const puntaje = document.getElementById('puntaje-evaluacion').value;
            const textoEvaluacion = document.getElementById('texto-evaluacion').value;
            
            // Validar formulario
            if (!tipoEvaluacion) {
                alert('Por favor, seleccione un tipo de evaluación');
                return;
            }
            
            if (!idPostulacion) {
                alert('No se puede evaluar a un candidato sin postulaciones registradas');
                return;
            }
            
            // Recopilar criterios seleccionados
            const criterios = [];
            document.querySelectorAll('#nuevaEvaluacionModal input[type="checkbox"]:checked').forEach(checkbox => {
                criterios.push(checkbox.value);
            });
            
            // Preparar datos estructurados
            const datosEstructurados = {
                criterios: criterios,
                fecha_evaluacion: new Date().toISOString()
            };
            
            // Enviar evaluación
            fetch(`${BASE_URL}/evaluaciones-humanas`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                },
                body: JSON.stringify({
                    id_postulacion: parseInt(idPostulacion),
                    id_usuario_evaluador: parseInt(localStorage.getItem('userId') || '1'), // Por defecto, ID 1 si no está disponible
                    tipo_evaluacion: tipoEvaluacion,
                    puntaje_numerico: parseFloat(puntaje),
                    texto_evaluacion: textoEvaluacion,
                    datos_estructurados: datosEstructurados
                })
            })
            .then(response => {
                if (!response.ok) throw new Error('Error al guardar la evaluación');
                return response.json();
            })
            .then(data => {
                alert('Evaluación guardada correctamente');
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('nuevaEvaluacionModal'));
                modal.hide();
                
                // Recargar evaluaciones si el modal de evaluaciones está abierto
                const evaluacionesModal = bootstrap.Modal.getInstance(document.getElementById('evaluacionesModal'));
                if (evaluacionesModal) {
                    cargarEvaluacionesCandidato(idCandidato);
                }
            })
            .catch(error => {
                console.error('Error al guardar evaluación:', error);
                alert('Error al guardar la evaluación: ' + error.message);
            });
        }

        function aplicarFiltros() {
            const filtroNombre = document.getElementById('filtro-nombre').value.toLowerCase();
            const filtroPartido = document.getElementById('filtro-partido').value;
            const filtroEstado = document.getElementById('filtro-estado').value;
            
            const candidatosFiltrados = candidatos.filter(candidato => {
                const cumpleNombre = !filtroNombre || 
                    `${candidato.nombres} ${candidato.apellido_paterno} ${candidato.apellido_materno || ''}`.toLowerCase().includes(filtroNombre);
                
                const cumplePartido = !filtroPartido || candidato.id_partido == filtroPartido;
                
                const cumpleEstado = !filtroEstado || candidato.estado_general === filtroEstado;
                
                return cumpleNombre && cumplePartido && cumpleEstado;
            });
            
            renderCandidatosTable(candidatosFiltrados);
        }

        function exportarDatos() {
            // Implementar función de exportación
            alert('Función de exportación en desarrollo');
        }

        // --- FUNCIONES DE CARGA DE DATOS ---

        async function cargarCandidatos() {
            try {
                const response = await fetch(`${BASE_URL}/candidatos`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (!response.ok) throw new Error('Error al cargar los candidatos');
                
                candidatos = await response.json();
                renderCandidatosTable(candidatos);
            } catch (error) {
                console.error('Error al cargar candidatos:', error);
                document.getElementById('tabla-candidatos').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger">Error al cargar los datos</td></tr>';
            }
        }

        async function cargarPartidos() {
            try {
                const response = await fetch(`${BASE_URL}/partidos`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (!response.ok) throw new Error('Error al cargar los partidos');
                
                partidos = await response.json();
                
                // Llenar selector de partidos en filtros
                const selector = document.getElementById('filtro-partido');
                selector.innerHTML = '<option value="">Todos los partidos</option>';
                partidos.forEach(partido => {
                    selector.innerHTML += `<option value="${partido.id_partido}">${partido.nombre_partido}</option>`;
                });
            } catch (error) {
                console.error('Error al cargar partidos:', error);
            }
        }

        async function cargarPostulacionesCandidato(idCandidato) {
            try {
                const response = await fetch(`${BASE_URL}/postulaciones?id_candidato=${idCandidato}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (!response.ok) throw new Error('Error al cargar las postulaciones del candidato');
                
                postulacionesCandidato = await response.json();
                return postulacionesCandidato;
            } catch (error) {
                console.error('Error al cargar postulaciones:', error);
                return [];
            }
        }

        async function cargarEvaluacionesCandidato(idCandidato) {
            try {
                // Primero cargamos las postulaciones del candidato
                await cargarPostulacionesCandidato(idCandidato);
                
                if (postulacionesCandidato.length === 0) {
                    renderEvaluaciones([]);
                    return;
                }
                
                // Cargamos las evaluaciones para cada postulación
                const evaluacionesPromises = postulacionesCandidato.map(postulacion => 
                    fetch(`${BASE_URL}/evaluaciones-humanas?id_postulacion=${postulacion.id_postulacion}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    })
                );
                
                const responses = await Promise.all(evaluacionesPromises);
                const evaluacionesData = await Promise.all(responses.map(res => res.json()));
                
                // Combinamos todas las evaluaciones
                evaluaciones = evaluacionesData.flat();
                renderEvaluaciones(evaluaciones);
            } catch (error) {
                console.error('Error al cargar evaluaciones:', error);
                document.getElementById('evaluaciones-container').innerHTML = 
                    '<p class="text-center text-danger">Error al cargar las evaluaciones</p>';
            }
        }

        // --- EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticación
            if (!localStorage.getItem('authToken')) {
                window.location.href = `/ALGARROBO_BASE/index.html`;
                return;
            }
            
            // Cargar datos iniciales
            cargarCandidatos();
            cargarPartidos();
            
            // Event listener para el slider de puntaje
            const puntajeSlider = document.getElementById('puntaje-evaluacion');
            const puntajeDisplay = document.getElementById('puntaje-display');
            
            if (puntajeSlider) {
                puntajeSlider.addEventListener('input', function() {
                    puntajeDisplay.textContent = this.value;
                });
            }
        });
    </script>
</body>
</html>